const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jspdf.es.min-DyX-NJIR.js","./typeof-DOuXJken.js","./modulepreload-polyfill-B5Qt9EMX.js","./pdf-loader-IGbdQEQu.js"])))=>i.map(i=>d[i]);
import"./modulepreload-polyfill-B5Qt9EMX.js";const Oe="modulepreload",Ne=function(t,e){return new URL(t,e).href},be={},Fe=function(e,r,n){let l=Promise.resolve();if(r&&r.length>0){let i=function(E){return Promise.all(E.map(o=>Promise.resolve(o).then(a=>({status:"fulfilled",value:a}),a=>({status:"rejected",reason:a}))))};const y=document.getElementsByTagName("link"),A=document.querySelector("meta[property=csp-nonce]"),$=(A==null?void 0:A.nonce)||(A==null?void 0:A.getAttribute("nonce"));l=i(r.map(E=>{if(E=Ne(E,n),E in be)return;be[E]=!0;const o=E.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!n)for(let f=y.length-1;f>=0;f--){const g=y[f];if(g.href===E&&(!o||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${E}"]${a}`))return;const u=document.createElement("link");if(u.rel=o?"stylesheet":Oe,o||(u.as="script"),u.crossOrigin="",u.href=E,$&&u.setAttribute("nonce",$),document.head.appendChild(u),o)return new Promise((f,g)=>{u.addEventListener("load",f),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${E}`)))})}))}function c(i){const y=new Event("vite:preloadError",{cancelable:!0});if(y.payload=i,window.dispatchEvent(y),!y.defaultPrevented)throw i}return l.then(i=>{for(const y of i||[])y.status==="rejected"&&c(y.reason);return e().catch(c)})},V=4,ce=3,De=[".png",".jpg",".jpeg",".gif",".webp"],C=de(),le=de(),Q=de(),ae=de();function de(){const t={};for(let e=1;e<=V;e++)t[e]=[];return t}function pe(t,e){var c;const r=(c=ae[t])==null?void 0:c[e];if(!r)return null;const{width:n,height:l}=r;return!Number.isFinite(n)||!Number.isFinite(l)?null:r}function he(t,e,r){if(!r)return;const{width:n,height:l}=r;!Number.isFinite(n)||!Number.isFinite(l)||(ae[t][e]={width:n,height:l})}function ke(t,e,r){Q[t][e]=r}const $e=10,Me=300,xe=3e3,We=1600,qe=1500;let U=null;function D(t,e=!1){const r=document.createElement("div");r.className="toast",r.style.zIndex="9999",e&&r.classList.add("error"),r.textContent=t,document.body.appendChild(r),setTimeout(()=>r.classList.add("show"),$e),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>document.body.removeChild(r),Me)},xe)}function ge(t){if(!U){U=document.createElement("div"),U.className="toast persistent",document.body.appendChild(U);const e=U;setTimeout(()=>{e&&e.classList.add("show")},$e)}U.textContent=t}function ve(t){U?U.textContent=t:ge(t)}function re(){if(U){const t=U;U=null,t.classList.remove("show"),setTimeout(()=>t.remove(),Me)}}function _e(t){const e=document.querySelector(`.images-container[data-segment="${t}"]`);if(!e)return;e.querySelectorAll(".image-wrapper").forEach((n,l)=>{var i;const c=!!((i=Q[t])!=null&&i[l]);n.classList.toggle("image-error",c)})}function je(t,e){const r=document.querySelector(`.images-container[data-segment="${t}"]`);if(!r)return;const n=r.querySelector(`.image-wrapper[data-image-index="${e}"]`);n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("image-error-focus"),setTimeout(()=>n.classList.remove("image-error-focus"),We))}function He(){document.querySelectorAll(".upload-area.segment-warning").forEach(t=>{t.classList.remove("segment-warning"),t.classList.remove("segment-warning-focus")})}function ue(t,e=!0){const r=document.querySelector(`.upload-area[data-segment="${t}"]`);r&&r.classList.toggle("segment-warning",e)}function Ce(t){const e=document.querySelector(`.upload-area[data-segment="${t}"]`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("segment-warning-focus"),setTimeout(()=>e.classList.remove("segment-warning-focus"),qe))}function Pe(t){const e=document.querySelector(`.images-container[data-segment="${t}"]`),r=document.querySelector(`.upload-area[data-segment="${t}"]`);if(!e||!r)return;const n=new Map;Array.from(e.querySelectorAll(".image-wrapper")).forEach(c=>{const i=Number(c.dataset.imageIndex);Number.isInteger(i)&&n.set(i,c)});const l=(c,i)=>{let y=n.get(c);if(!y){y=Ge(t,c,i),e.appendChild(y),n.set(c,y);return}if(y.dataset.imageSrc!==i){const A=y.querySelector("img");A&&(A.src=i,A.alt=`Code screenshot ${c+1}`),y.dataset.imageSrc=i}y.dataset.imageIndex=c};C[t].forEach((c,i)=>l(i,c)),n.forEach((c,i)=>{i>=C[t].length&&c.parentNode===e&&(e.removeChild(c),n.delete(i))}),C[t].length>0?r.classList.add("has-images"):r.classList.remove("has-images"),_e(t)}function Ge(t,e,r){const n=document.createElement("div");n.className="image-wrapper",n.dataset.imageIndex=e,n.dataset.segment=String(t),n.dataset.imageSrc=r;const l=document.createElement("img");l.src=r,l.alt=`Code screenshot ${e+1}`;const c=document.createElement("button");return c.className="remove-button",c.innerHTML="×",n.appendChild(l),n.appendChild(c),n}function we(t){const e=document.querySelector(`.image-count[data-count="${t}"]`),r=C[t].length;e.textContent=`${r} / ${ce} images`;const n=document.querySelector(`.upload-area[data-segment="${t}"]`),l=n?n.querySelector(".upload-button"):null;r>=ce?(n.style.opacity="0.6",n.style.cursor="not-allowed"):(n.style.opacity="1",n.style.cursor="pointer"),l&&(l.disabled=r>=ce)}const Be=1600,Ue=1600;async function ze(){const{jsPDF:t}=await Fe(async()=>{const{jsPDF:n}=await import("./jspdf.es.min-DyX-NJIR.js");return{jsPDF:n}},__vite__mapDeps([0,1,2]),import.meta.url);async function e(n,{maxWidth:l=Be,maxHeight:c=Ue,outputType:i="image/png"}={}){return new Promise((y,A)=>{try{const $=new Image;$.onload=()=>{let{width:E,height:o}=$;if(E>l||o>c){const u=Math.min(l/E,c/o);E=Math.floor(E*u),o=Math.floor(o*u)}const a=document.createElement("canvas");a.width=E,a.height=o;const d=a.getContext("2d");d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.drawImage($,0,0,E,o),y(a.toDataURL(i))},$.onerror=()=>{console.warn("Failed to load image for compression; rejection passed to caller"),A(new Error("Image load failed during compression"))},$.src=n}catch($){console.warn("compressDataUrl encountered an unexpected error, rejecting",$),A($)}})}function r(n){const l=new TextEncoder().encode(n);let c="";for(let i=0;i<l.length;i++)c+=String.fromCharCode(l[i]);return btoa(c)}return{jsPDF:t,compressDataUrl:e,encodeForPdf:r}}const Le=16,Ie=12,Ye="PPRDATA:",Ae=10,_=Object.freeze({marginPt:40,contentStartYPt:90,headerNameYPt:40,headerTitleYPt:60,textLineHeightPt:16,imageGapPt:14,segmentGapPt:10,nameLabelGapPt:6,nameUnderlineOffsetPt:3,nameUnderlineWidthPt:.5});function Ve(t){const{segmentImages:e,imageCompressionState:r,imageProcessingErrors:n,SEGMENT_COUNT:l,SEGMENT_LABEL_LINES:c,getCachedImageDimensions:i,storeImageDimensions:y,measureImageDimensions:A,ensureAllImageDimensions:$,setImageProcessingError:E,showToast:o,scrollToImageError:a,flagSegmentLoadWarning:d,focusSegmentLoadWarning:u}=t;function f(s,P,T){var b;const S=[],v={};for(let m=1;m<=l;m++){const L=((b=s[m])==null?void 0:b.length)||0;v[m]=[];for(let p=0;p<L;p++){const w=`seg${m}-img${p+1}`;v[m].push(w),S.push({alias:w,segment:m})}}return{payload:{studentName:P,segments:Object.keys(s).reduce((m,L)=>(m[L]=s[L].length,m),{}),timestamp:T,imageManifest:S},aliasMap:v}}function g(s,P,T,S){const v=JSON.stringify(P),b=T(v),m=`${Ye}${b}`;s.setProperties({title:"Practice Personalized Project Reference",subject:"Practice AP CSP Create Task Personalized Project Reference",author:S||"",keywords:m})}function O(s,P,T,S,v){const b=Math.min(Ae,S*.05),m=Math.min(Ae,v*.05);return(P<b||T<m)&&(s.width<b&&s.height<m||P<b/2||T<m/2)}function x({isFirstImageInSegment:s,pageHeight:P,margin:T,segLines:S,index:v,segment:b,renderedWidth:m,renderedHeight:L}){const p=P-T*2-S.length*_.textLineHeightPt<=0,w=s&&p?"noSpaceAfterLabels":"tooSmall",q=w==="noSpaceAfterLabels"?`Segment ${b} labels leave no room for image ${v+1}.`:`Image ${v+1} in segment ${b} is too small after scaling (${m.toFixed(0)}x${L.toFixed(0)}px).`;return{code:w,message:q}}async function k(s,P,T=[],{onProgress:S}={},v={},b=[]){const m=s.internal.pageSize.getWidth(),L=s.internal.pageSize.getHeight(),p=_.marginPt;await $(P);let w=_.contentStartYPt;const q=m-p*2,j=L-p*2,X=new Map,Y=()=>typeof s.internal.getCurrentPageInfo=="function"?s.internal.getCurrentPageInfo().pageNumber||1:s.internal.pages&&s.internal.pages.length>0?s.internal.pages.length-1:1;let B=Y();const H=(I,M,z)=>{Array.isArray(T)&&T.push({segment:I,index:M,reason:z})},Z=(I,M)=>{const z=(X.get(B)||0)+1;X.set(B,z),M&&Array.isArray(b)&&b.push({alias:M,segment:I,page:B,order:z})};let K=0;const se=Object.values(P).reduce((I,M)=>I+((M==null?void 0:M.length)||0),0);for(let I=1;I<=l;I++){const M=P[I]||[];if(!M.length)continue;const z=c[I]||[];let F=!0;for(let h=0;h<M.length;h++){const N=M[h];try{let R=i(I,h);if(!R)try{const G=s.getImageProperties(N);R={width:G.width,height:G.height},y(I,h,R)}catch{try{R=await A(N),y(I,h,R)}catch{console.warn(`Could not determine dimensions for image ${h+1} in segment ${I}. Skipping this image.`),H(I,h,"dimensions");continue}}let te=Math.min(q/R.width,j/R.height,1),ie=R.width*te,J=R.height*te;if(O(R,ie,J,q,j)){const G=x({isFirstImageInSegment:F,pageHeight:L,margin:p,segLines:z,index:h,segment:I,renderedWidth:ie,renderedHeight:J});o(G.message,!0),H(I,h,G.code);continue}if(F){const G=z,ne=G.length*_.textLineHeightPt,me=L-p-w;if(J+ne>me){s.addPage(),B=Y(),w=p;const fe=L-p*2-ne;te=Math.min(q/R.width,fe/R.height,1),ie=R.width*te,J=R.height*te}for(const fe of G)s.text(fe,p,w),w+=_.textLineHeightPt;F=!1}else if(w+J>L-p){s.addPage(),B=Y(),w=p;const G=z[z.length-1],ne=typeof G=="string"?G.trim():"";if(ne){const me=`${ne} (cont.)`;s.text(me,p,w),w+=_.textLineHeightPt}}const Ee=v==null?void 0:v[I],Se=Array.isArray(Ee)?Ee[h]:void 0;Z(I,Se),s.addImage(N,"PNG",p,w,ie,J,Se,"FAST"),K+=1,typeof S=="function"&&await S({embedded:K,total:se}),w+=J+_.imageGapPt}catch(R){console.error("Image add error",R),H(I,h,"renderError")}}w+=_.segmentGapPt}}async function W(s,{onProgress:P}={}){if(typeof s!="function")throw new Error("compressDataUrl function required to build payload");const T={},S=[],v=Object.values(e).reduce((m,L)=>m+((L==null?void 0:L.length)||0),0);let b=0;for(let m=1;m<=l;m++){const L=e[m]||[];T[m]=[];for(let p=0;p<L.length;p++){const w=L[p],q=r[m][p];try{let j;q?j=w:j=await s(w,{maxWidth:1600,maxHeight:1600,outputType:"image/png"}),T[m].push(j),n[m][p]&&E(m,p,!1),b+=1,v&&typeof P=="function"&&await P({processed:b,total:v})}catch(j){console.warn("Failed to process image, skipping",j),E(m,p,!0),S.push({segment:m,index:p,error:j})}}}return{images:T,failures:S}}async function ee({doc:s,compressDataUrl:P,encodeForPdf:T,studentName:S,timestamp:v,updateSaveProgress:b}){const L=Object.values(e).reduce((F,h)=>F+((h==null?void 0:h.length)||0),0)||"?";await b(`Processing PPR images (0 of ${L})...`);const{images:p,failures:w}=await W(P,{onProgress:async({processed:F,total:h})=>{await b(`Processing PPR images (${F} of ${h||L})...`)}});if(w.length){const F=[...new Set(w.map(({segment:N})=>N))].map(N=>`Segment ${N}`).join(", ");o(`Failed to prepare ${w.length} image(s). ${F} need attention before saving.`,!0),a(w[0].segment,w[0].index);const h=new Error("IMAGE_COMPRESSION_FAILED");throw h.code="IMAGE_COMPRESSION_FAILED",h}const q=Object.values(p).reduce((F,h)=>F+((h==null?void 0:h.length)||0),0);await b(`Embedding images into PDF (0 of ${q||"?"})...`);const{payload:j,aliasMap:X}=f(p,S,v),Y=S||"",B=_.headerNameYPt,H=s.internal.pageSize.getWidth();s.setFontSize(Ie);const Z="Name:";s.text(Z,_.marginPt,B);const K=_.marginPt+s.getTextWidth(`${Z} `);s.setFontSize(Le),s.text(Y,K+_.nameLabelGapPt,B);const se=B+_.nameUnderlineOffsetPt,I=typeof s.getLineWidth=="function"?s.getLineWidth():null;s.setLineWidth(_.nameUnderlineWidthPt),s.line(K,se,H-_.marginPt,se),typeof I=="number"&&s.setLineWidth(I),s.setFontSize(Le),s.text("Practice AP CSP Create Task Personalized Project Reference",_.marginPt,_.headerTitleYPt),s.setFontSize(Ie);const M=[];if(await k(s,p,M,{onProgress:async({embedded:F,total:h})=>{await b(`Embedding images into PDF (${F} of ${h||q||"?"})...`)}},X,[]),g(s,j,T,S),M.length){const F=[...new Set(M.map(({segment:N})=>N))],h=F.map(N=>`Segment ${N}`).join(", ");o(`${M.length} image(s) were skipped because they were unreadable or too small to render. ${h} need attention before saving.`,!0),F.forEach(N=>d(N,!0)),F.length&&u(F[0])}}return{generatePdfDocument:ee}}function Xe(t){if(!t||typeof t.name!="string")return!1;const e=t.name.toLowerCase();return De.some(r=>e.endsWith(r))}const Je=(t,e="image was",r="images were")=>t===1?e:r,Ze=()=>De.map(t=>t.replace(/^\./,"").toUpperCase()).join(", ");function Ke({addImage:t,handleSegmentImagesClick:e,parsePprJson:r,applyLoadedData:n,generatePdfDocument:l,markWorkspaceUnmodified:c,maxImagesPerSegment:i=ce,uiUpdateDelay:y=50}){if(typeof t!="function")throw new Error("addImage handler is required");if(typeof e!="function")throw new Error("handleSegmentImagesClick handler is required");if(typeof r!="function")throw new Error("parsePprJson function is required");if(typeof n!="function")throw new Error("applyLoadedData function is required");if(typeof l!="function")throw new Error("generatePdfDocument function is required");if(typeof c!="function")throw new Error("markWorkspaceUnmodified function is required");function A(a,d){const u=i-C[d].length,f=a.reduce((O,x)=>(Xe(x)?O.valid.push(x):O.invalidCount+=1,O),{valid:[],invalidCount:0}),g=f.valid.slice(0,Math.max(u,0));g.forEach(O=>{const x=new FileReader;x.onload=k=>{t(k.target.result,d)},x.readAsDataURL(O)}),f.invalidCount>0&&D(`Some files were rejected because only image formats are supported (${Ze()}).`,!0),f.valid.length>g.length&&D(`Only ${g.length} ${Je(g.length)} added. Each segment is limited to ${i} images.`,!0)}function $(a){const d=document.querySelector(`.upload-area[data-segment="${a}"]`),u=document.querySelector(`.hidden-input[data-segment="${a}"]`),f=document.querySelector(`.images-container[data-segment="${a}"]`);!d||!u||!f||(f.dataset.removeHandlerBound||(f.addEventListener("click",e),f.dataset.removeHandlerBound="true"),d.addEventListener("click",()=>{C[a].length<i?u.click():D(`This segment already has ${i} images. Remove one before adding another.`,!0)}),d.addEventListener("dragover",g=>{g.preventDefault(),d.classList.add("drag-over")}),d.addEventListener("dragleave",()=>{d.classList.remove("drag-over")}),d.addEventListener("drop",g=>{if(g.preventDefault(),d.classList.remove("drag-over"),C[a].length>=i){D(`This segment already has ${i} images. Remove one before adding another.`,!0);return}const O=Array.from(g.dataTransfer.files);A(O,a)}),u.addEventListener("change",g=>{const O=Array.from(g.target.files);A(O,a),u.value=""}))}async function E(){const a=document.querySelector(".action-button.save");if(!a)return;const d=a.innerHTML;a.disabled=!0,a.innerHTML="⏳ Saving...",ge("Preparing PDF...");const u=async f=>{ve(f),await new Promise(requestAnimationFrame)};await new Promise(f=>setTimeout(f,y));try{const{jsPDF:f,compressDataUrl:g,encodeForPdf:O}=await ze(),x=document.getElementById("student-name").value,k=new Date().toISOString().split(".")[0].replace(/:/g,"-").replace("T","_"),W=new f({unit:"pt",format:"letter"}),ee=Object.values(C).some(P=>(P||[]).length),s=(P=!0)=>{const S=`${x?x.replace(/\s+/g,"-"):"Student"}-PPR-${k}.pdf`;if(P)try{W.save(S),D("PDF created"),c()}catch(v){D("Failed to save PDF",!0),console.error(v)}re(),a.disabled=!1,a.innerHTML=d};ee?l({doc:W,compressDataUrl:g,encodeForPdf:O,studentName:x,timestamp:k,updateSaveProgress:u}).then(()=>s(!0)).catch(P=>{console.error("Save error",P),(!P||P.code!=="IMAGE_COMPRESSION_FAILED")&&D("Failed to save PDF",!0),requestAnimationFrame(()=>s(!1))}):(D("Add at least one image before exporting your PPR.",!0),s(!1))}catch(f){console.error("Save error:",f),D("Failed to save",!0),re(),a.disabled=!1,a.innerHTML=d}}async function o(){const a=document.querySelector(".action-button.load");if(!a)return;const d=a.innerHTML,u=document.createElement("input");u.type="file",u.accept=".pdf,.ppr,.json,application/pdf,application/json",u.onchange=async f=>{const g=f.target.files[0];if(!g)return;a.disabled=!0,a.innerHTML="⏳ Loading...";const O=g.type==="application/pdf"||g.name.toLowerCase().endsWith(".pdf"),x=k=>{try{const W=r(k);W?(n(W),D("Work loaded successfully!")):D("File contents were invalid. Please make sure it is a valid PPR save file.",!0)}catch(W){D("Error loading file. Please make sure it is a valid PPR save file.",!0),console.error("Load error:",W)}finally{a.disabled=!1,a.innerHTML=d}};if(O){const k=await Fe(()=>import("./pdf-loader-IGbdQEQu.js"),__vite__mapDeps([3,2]),import.meta.url),{extractImagesFromPdf:W,readEmbeddedPprData:ee}=await k.createPdfLoader(),{reconstructPprDataFromPdf:s}=k,P=new FileReader;P.onload=async T=>{try{const S=T.target.result,v=await ee(S.slice(0));if(!v){D('Could not load PDF. Only PPR PDFs saved from this site using "Save to PDF" can be loaded.',!0),a.disabled=!1,a.innerHTML=d;return}const b=r(v);if(!b){D("The embedded PPR data was invalid or corrupted.",!0),re();return}ge("Reading PDF...");const m=async H=>{ve(H),await new Promise(requestAnimationFrame)},L=W(S.slice(0),{onProgress:async({page:H,totalPages:Z})=>{await m(`Processing PDF pages (${H} of ${Z??"?"})...`)}});await m("Processing PDF pages (0 of ?)...");const{images:p,imagePlacements:w=[],skippedImages:q=[]}=await L;await m("Rebuilding workspace...");const{workspaceData:j,notices:X,segmentsWithMissingImages:Y,missingImages:B}=s({metadata:b,extractedImages:p,extractedPlacements:w,skippedImages:q,segmentCount:V});if(n(j),Y.length&&(Y.forEach(H=>ue(H,!0)),Ce(Y[0])),X.length){const H=B.length>0||q.length>0;D(X.join(" "),H)}else D("Work loaded from PDF!");re()}catch(S){re(),D("Error loading PDF. Make sure it was saved from here.",!0),console.error("Load error:",S)}finally{a.disabled=!1,a.innerHTML=d}},P.readAsArrayBuffer(g)}else{const k=new FileReader;k.onload=W=>x(W.target.result),k.readAsText(g)}},u.click()}return{setupSegment:$,savePprPdf:E,loadPprPdf:o}}let oe=!1;const Qe=50,et={1:["Procedure","i."],2:["ii."],3:["List","i."],4:["ii."]};function ye(t){return new Promise((e,r)=>{const n=new Image;n.onload=()=>e({width:n.naturalWidth,height:n.naturalHeight}),n.onerror=()=>r(new Error("Could not load image data")),n.src=t})}function Re(t,e,r){return!r||pe(t,e)?Promise.resolve():ye(r).then(n=>he(t,e,n)).catch(n=>console.warn(`Failed to cache dimensions for segment ${t} image ${e+1}`,n))}async function tt(t){const e=[];for(let r=1;r<=V;r++)(t[r]||[]).forEach((l,c)=>{pe(r,c)||e.push(ye(l).then(i=>he(r,c,i)).catch(i=>console.warn(`Failed to preload dimensions for segment ${r} image ${c+1}`,i)))});e.length&&await Promise.all(e)}function Te(){mt()}const{generatePdfDocument:nt}=Ve({segmentImages:C,imageCompressionState:le,imageProcessingErrors:Q,SEGMENT_COUNT:V,SEGMENT_LABEL_LINES:et,getCachedImageDimensions:pe,storeImageDimensions:he,measureImageDimensions:ye,ensureAllImageDimensions:tt,setImageProcessingError:st,showToast:D,scrollToImageError:je,flagSegmentLoadWarning:ue,focusSegmentLoadWarning:Ce}),{setupSegment:rt,savePprPdf:at,loadPprPdf:ot}=Ke({addImage:it,handleSegmentImagesClick:lt,parsePprJson:ut,applyLoadedData:dt,generatePdfDocument:nt,markWorkspaceUnmodified:()=>{oe=!1},uiUpdateDelay:Qe});function st(t,e,r){ke(t,e,r),_e(t)}function it(t,e){C[e].push(t);const r=C[e].length-1;le[e].push(!1),ue(e,!1),Q[e].push(!1),ae[e][r]=null,Re(e,r,t),Pe(e),we(e),oe=!0}function ct(t,e){C[e].splice(t,1),le[e].splice(t,1),ue(e,!1),Q[e].splice(t,1),ae[e].splice(t,1),Pe(e),we(e),oe=!0}function lt(t){const e=t.target.closest(".remove-button");if(!e)return;const r=e.closest(".image-wrapper"),n=e.closest(".images-container");if(!r||!n)return;t.stopPropagation();const l=Number(n.dataset.segment),c=Number(r.dataset.imageIndex);!Number.isInteger(l)||!Number.isInteger(c)||ct(c,l)}function dt(t){if(!t)return;He();const e=[];if(t.studentName&&(document.getElementById("student-name").value=t.studentName),t.images)for(let r in t.images){const n=parseInt(r,10);Number.isInteger(n)&&(C[n]=t.images[r],le[n]=new Array(C[n].length).fill(!0),Q[n]=new Array(C[n].length).fill(!1),ae[n]=new Array(C[n].length).fill(null),C[n].forEach((l,c)=>{const i=Re(n,c,l);i&&typeof i.then=="function"&&e.push(i)}),Pe(n),we(n))}e.length&&Promise.all(e).catch(r=>console.warn("Failed to preload some image dimensions after loading data",r)),oe=!1}function ut(t){try{const e=JSON.parse(t);if(!e||typeof e!="object")throw new Error("Parsed data is not an object");if(e.images&&(typeof e.images!="object"||Array.isArray(e.images)))throw new Error("Images payload malformed");if(e.segments&&(typeof e.segments!="object"||Array.isArray(e.segments)))throw new Error("Segments payload malformed");const r={};if(e.images)for(let o=1;o<=V;o++){const a=e.images[o];if(!Array.isArray(a)){r[o]=[];continue}if(!a.every(d=>typeof d=="string"))throw new Error(`Images for segment ${o} malformed`);r[o]=a}const n={};if(e.segments)for(let o=1;o<=V;o++){const a=Number(e.segments[o]);if(!Number.isFinite(a)||a<0)throw new Error(`Segment count for ${o} invalid`);n[o]=a}let l;const c=o=>typeof o=="string"||typeof o=="number",i=o=>!!o&&typeof o=="object",y=o=>i(o)&&typeof o.alias=="string"?o.alias:typeof o=="string"?o:null,A=o=>{if(i(o)&&Number.isFinite(Number(o.segment)))return Number(o.segment);if(c(o)){const a=Number(o);return Number.isFinite(a)?a:null}return null},$=o=>{if(!o)return null;const a=y(o),d=A(o);return typeof a!="string"||a.length===0||!Number.isInteger(d)||d<1||d>V?null:{alias:a,segment:d}};if(Array.isArray(e.imageManifest)){const o=[];let a=!0;e.imageManifest.forEach(d=>{if(!a)return;const u=$(d);u?o.push(u):a=!1}),a&&(l=o)}else if(Array.isArray(e.imageOrder)){const o=[],a={};e.imageOrder.forEach(d=>{const u=Number(d);if(Number.isInteger(u)&&u>=1&&u<=V){const f=a[u]||0,g=`seg${u}-img${f+1}`;o.push({alias:g,segment:u}),a[u]=f+1}}),o.length&&(l=o)}let E;if(Array.isArray(e.imagePlacements)){const o=[];let a=!0;e.imagePlacements.forEach(d=>{if(!a)return;const u=typeof d.alias=="string"?d.alias:null,f=Number(d.page),g=Number(d.order);u&&Number.isFinite(f)&&f>=1&&Number.isFinite(g)&&g>=1?o.push({alias:u,page:f,order:g}):a=!1}),a&&(E=o)}return{studentName:typeof e.studentName=="string"?e.studentName:"",images:e.images?r:void 0,segments:e.segments?n:void 0,timestamp:e.timestamp,imageManifest:l,imagePlacements:E}}catch(e){return console.error("Failed to parse PPR metadata",e),null}}function mt(){for(let n=1;n<=V;n++)rt(n);const t=document.querySelector(".action-button.save"),e=document.querySelector(".action-button.load");t&&t.addEventListener("click",at),e&&e.addEventListener("click",ot),window.addEventListener("beforeunload",n=>{if(oe)return n.preventDefault(),n.returnValue="",""}),new URLSearchParams(window.location.search).has("nolist")&&document.querySelectorAll(".list-section").forEach(n=>{n.classList.add("hidden")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Te()}):Te();export{Fe as _};
